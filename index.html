<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Celestial</title>
		<meta charset="utf-8">
		<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" /> 
		<meta name="description" content="HTML5 Canvas Celestial System using Three.js - by Jay Crossler" /> 
		<meta name="keywords" content="html5, canvas, maptiles, sprites, spritesheets" /> 
		<meta name="robots" content="index, follow" /> 

		<style type="text/css">
			body {
				color: #808080;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #000000;
				margin: 0px;
				padding:0;
				height:100%;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a, span {
				color: #0080ff;
				cursor: pointer; cursor: hand;
			}
			
			#planetinfo {
				position: absolute;
				width: 150px; height: 150px;
				background-color: #200;
				padding: 5px;
				right: 10px; bottom: 10px;
				-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
				filter: alpha(opacity=50);
				opacity: 0.5;
			}

			//Handles mouse bouncing and other iPad-specific issues
			* {
			  -webkit-touch-callout: none;
			  -webkit-text-size-adjust: none;
			  -webkit-tap-highlight-color: rgba(0,0,0,0);
			  -webkit-user-select: none;
			}

		</style>
		<script type="text/javascript" src="js/Stats.js"></script>
		<script type="text/javascript" src="js/Three.js"></script>
		<script type="text/javascript" src="js/Celestial.js"></script>
		<script type="text/javascript" src="planets.json"></script>
	</head>
	<body onload="preloader()">

		<div id="container"><br/><h1>Loading</h1></div> 
		<div id="info">
<!--			Spacing:<span id="click1" onclick="clickit(1)">Evenly</span>::<span id="click2" onclick="clickit(2)">Realistic</span>::<span id="click3" onclick="clickit(3)">Artistic</span>
			Sizing:<span id="click4" onclick="clickit(4)">Equal</span>::<span id="click5" onclick="clickit(5)">Realistic</span>::<span id="click6" onclick="clickit(6)">Artistic</span><br/>
-->			View:<span id="click7" onclick="clickit(7)">Panning(p)</span>::<span id="click8" onclick="clickit(8)">Log(l)</span>::<span id="click9" onclick="clickit(9)">Inner</span>
			[Adv <span onclick="clickit(11)">D</span>:<span onclick="clickit(12)">H</span>:<span onclick="clickit(13)">M</span>:<span onclick="clickit(14)">S</span> per frame]
			<br/><span id="timedisplay" style="color:white" onclick="clickit(10)"></span>
		</div>

	<div id="planetinfo"></div>

		<script type="text/javascript">
			var option_PanScreenWithMouse = true, //when mouse moves, use it to pan camera
				option_RenderWebGL = true, //Use the 3D graphics acceleration
				option_SphereQuality = 20, //how many tessalations to use when drawing spheres, more = higher resource use
				option_ZoomOnClick = false, //Zoom ahead when the mouse is clicked
				option_SolarSystem3DSizeXZ = 400, // how many "3d" pixels to use in the system length, width
				option_SolarSystem3DSizeY = 250, // how many "3d" pixels to use in the system's height
				option_TimeAdvanceType = 'h', // 'h','m','d','s', rate; how often to advance per second
				option_TargetFPS = 30; // Goal for # of frames per second
			
			var planetmeshlist = [];
			
			var container, stats, timedisplay, planetinfo;
			var camera, moveForward, moveBackward, moveShouldStop=false;
			var mesh, scene, renderer, projector, texture_placeholder;
			var loginfo=0;

			var mouseX = 0, mouseY = -100;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;



			function preloader() {
				document.getElementById('container').innerHTML="<br/><br/><br/><br/><h1>Loading Images</h1>";

				 // create object
				 imageObj = new Image();
			
				 // set image list
				 images = new Array();
				 images[0]="textures/Sol_surface.jpg"
				 images[1]="textures/Mercury_surface.jpg"
				 images[2]="textures/Venus_surface.jpg"
				 images[3]="textures/Earth_surface.jpg"
				 images[4]="textures/Mars_surface.jpg"
				 images[5]="textures/Jupiter_surface.jpg"
				 images[6]="textures/Saturn_surface.jpg"
				 images[7]="textures/Uranus_surface.jpg"
				 images[8]="textures/Neptune_surface.jpg"
				 images[9]="textures/Pluto_surface.jpg"
				 images[10]="textures/skybox/hot_nebula_90.jpg"
				 images[11]="textures/skybox/hot_nebula_270.jpg"
				 images[12]="textures/skybox/hot_nebula_top.jpg"
				 images[13]="textures/skybox/hot_nebula_bottom.jpg"
				 images[14]="textures/skybox/hot_nebula_0.jpg"
				 images[15]="textures/skybox/hot_nebula_180.jpg"
			
				 // start preloading
				 for(var i=0; i<images.length; i++) 
				 {
					  imageObj.src=images[i];
				 }
				 
				//Start the simulation
				document.getElementById('container').innerHTML="";
				init();
				setInterval( loop, 1000 / option_TargetFPS );
			} 


			function init() {
				container = document.getElementById( 'container'  );
				timedisplay=document.getElementById( 'timedisplay');
				planetinfo =document.getElementById( 'planetinfo' );

				init_camera();

				scene = new THREE.Scene();

// 		material = new THREE.ParticleBasicMaterial( { map: ImageUtils.loadTexture( 'textures/nova_particle.png' ), blending: THREE.AdditiveBlending } );
// 
// 		for ( var i = 0; i < 1000; i ++ ) {
// 			particle = new THREE.Particle( material );
// 			particle.position.x = Math.random() * 40 - 20;
// 			particle.position.y = Math.random() * 40 - 20;
// 			particle.position.z = Math.random() * 40 - 20;
// 			particle.scale.x = particle.scale.y = Math.random() * 3;
// 			scene.addObject( particle );
// 		}
// 
// 		particle = new THREE.Particle( new THREE.ParticleBasicMaterial( { map: ImageUtils.loadTexture( 'textures/sun.png' ), blending: THREE.AdditiveBlending } ) );
// 		scene.addObject( particle );

		particle = new THREE.Particle( new THREE.ParticleBasicMaterial( { map: ImageUtils.loadTexture( 'textures/sun.png' ), blending: THREE.AdditiveBlending } ) );
		scene.addObject( particle );
		
				init_sky();
				//init_cylinder();
				init_grid();
				//init_shadow();
				init_planets();
				
//				scene.addLight( new THREE.AmbientLight( 0x202020 ) );
				
				init_renderer();
				
				init_stats();
				clickit();

			}
			function init_sky() {
				texture_placeholder = document.createElement( 'canvas' );
				texture_placeholder.width = 512;
				texture_placeholder.height = 512;
				
				//Textures from Flex2D Cookbox - http://code.google.com/p/flex3cookbook1/downloads/list
				var materials = [
					loadTexture( 'textures/skybox/hot_nebula_90.jpg' ), // left
					loadTexture( 'textures/skybox/hot_nebula_270.jpg' ), // right
					loadTexture( 'textures/skybox/hot_nebula_top.jpg' ), // top
					loadTexture( 'textures/skybox/hot_nebula_bottom.jpg' ), // bottom
					loadTexture( 'textures/skybox/hot_nebula_0.jpg' ), // back
					loadTexture( 'textures/skybox/hot_nebula_180.jpg' )  // front
// 					loadTexture( 'textures/skybox/night_1.jpg' ), // right
// 					loadTexture( 'textures/skybox/night_2.jpg' ), // left
// 					loadTexture( 'textures/skybox/night_3.jpg' ), // top
// 					loadTexture( 'textures/skybox/night_4.jpg' ), // bottom
// 					loadTexture( 'textures/skybox/night_5.jpg' ), // back
// 					loadTexture( 'textures/skybox/night_7.jpg' )  // front
				];

				mesh = new THREE.Mesh( new Cube( option_SolarSystem3DSizeXZ*5, option_SolarSystem3DSizeXZ*5, option_SolarSystem3DSizeXZ*5, 7, 7, materials, true ), new THREE.MeshFaceMaterial() );
				mesh.overdraw = true;
				scene.addObject( mesh );			
			}
			function init_cylinder() {
				// Top and bottom Cylinders (flat, so they look like circles)				
				// ( numSegs, topRad, botRad, height, topOffset, botOffset )
				var cylinder = new THREE.Mesh(new Cylinder( 20, option_SolarSystem3DSizeXZ, option_SolarSystem3DSizeXZ, 0, 0, 0),
					[new THREE.MeshBasicMaterial( {color: 0x222222, opacity: 1} ) ,
					 new THREE.MeshBasicMaterial( {color: 0x222222, wireframe: true }) ] );
				cylinder.position.x = 0;
				cylinder.position.y = ( option_SolarSystem3DSizeY);
				cylinder.position.z = 0;
				cylinder.rotation.x = (Math.PI / 2);
				scene.addObject(cylinder);

				var cylinder = new THREE.Mesh(new Cylinder( 20, option_SolarSystem3DSizeXZ, option_SolarSystem3DSizeXZ, 0, 0, 0),
					[new THREE.MeshBasicMaterial( {color: 0x222222, opacity: 1} ) ,
					 new THREE.MeshBasicMaterial( {color: 0x222222, wireframe: true }) ] );			 
				cylinder.position.x = 0;
				cylinder.position.y = (-1 * option_SolarSystem3DSizeY);
				cylinder.position.z = 0;
				cylinder.rotation.x = (Math.PI / 2);
				scene.addObject(cylinder);

			}			
			function init_grid() {
				// Grid
				var geometry = new THREE.Geometry();
				geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( -1 * option_SolarSystem3DSizeXZ, 0, 0 ) ) );
				geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( option_SolarSystem3DSizeXZ, 0, 0 ) ) );

				var material = new THREE.LineBasicMaterial( { color: 0x222222, opacity: 0.8 } );
				var lineSteps = 10;
				for ( var i = 0; i <= lineSteps; i ++ ) {
					var step = (option_SolarSystem3DSizeXZ *2) / lineSteps;

					var line = new THREE.Line( geometry, material );
					line.position.y = 0;
					line.position.z = ( i * step ) - option_SolarSystem3DSizeXZ;
					scene.addObject( line );

					var line = new THREE.Line( geometry, material );
					line.position.x = ( i * step ) - option_SolarSystem3DSizeXZ;
					line.position.y = 0;
					line.rotation.y = Math.PI / 2;
					scene.addObject( line );

				}
				console.log('Grid created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_shadow() {
				mesh = new THREE.Mesh( new Plane( 300, 300, 3, 3 ), new THREE.MeshBasicMaterial( { map: ImageUtils.loadTexture( 'textures/shadow.png' ) } ) );
				mesh.position.y = - 250;
				mesh.rotation.x = - 90 * Math.PI / 180;
				scene.addObject(mesh);
				console.log('Shadow created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_planets() {
				Celestial.init(planet_init_list,option_SolarSystem3DSizeXZ,option_SolarSystem3DSizeY);

				var resolution = 60;
				var size = 360 / resolution;
			
				material = new THREE.LineBasicMaterial( { color: 0x008080, opacity: 0.5, blending: THREE.AdditiveBlending } );

				for ( var i = 0, l = Celestial.planetsCount(); i < l; i ++ ) {
					var mesh = create_planet(i);
					if (Celestial.planetInfo(i,'type') == 'star') {
						var meshstar = new THREE.Mesh( new Sphere( Celestial.planetInfo(i,'pixelwidth')*1.2,option_SphereQuality,option_SphereQuality ),
								   	   new THREE.MeshBasicMaterial( { color: 0x665500, blending: THREE.AdditiveBlending }) );
						meshstar.overdraw = true;
						scene.addObject( meshstar );
					} else {
						//For each step of the planet's location, build a series of orbit lines
						var orbitepochstep = Celestial.Planets[i].orbit_sidereal_in_days / resolution;
						geometry = new THREE.Geometry();		
						for ( var j = 0; j <= resolution; j ++ ) {		
							segment = ( j * size ) * Math.PI / 180;
							var orbitepoch = orbitepochstep * (j+1);
							var orbitpos = Celestial.planetLocation(i,orbitepoch);
							geometry.vertices.push( new THREE.Vertex( new THREE.Vector3(
								orbitpos.position.x,
								orbitpos.position.y,
								orbitpos.position.z)));
						}
						line = new THREE.Line( geometry, material );
						scene.addObject( line );

					}				
					planetmeshlist.push( mesh );
					scene.addObject( mesh );


				}
			
				console.log('Planets created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_camera() {
				camera = new THREE.Camera( 60, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.y = option_SolarSystem3DSizeXZ;
				camera.position.z = option_SolarSystem3DSizeXZ;
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
				document.addEventListener( 'contextmenu', function ( event ) { event.preventDefault(); }, false ); //prevent right click menu
				document.addEventListener( 'DOMMouseScroll', onDocumentMouseScroll, false);
				document.addEventListener( 'mousewheel', onDocumentMouseScroll, false);
				document.addEventListener( 'keydown', onDocumentKeyDown, false);
				container.addEventListener('touchstart', touchHandler, false);	
				container.addEventListener('touchmove', touchHandler, false);	
				container.addEventListener('touchend', touchHandler, false);	
				container.addEventListener("touchcancel", touchHandler, true); 
				window.addEventListener( 'resize', onWindowResize, false );

				projector = new THREE.Projector();

			}
			//----------------
			//From: http://ross.posterous.com/2008/08/19/iphone-touch-events-in-javascript
			//Intercepts iOs and Android touch events, turns into drag events
			function touchHandler(event)
			{
				var touches = event.changedTouches,
					first = touches[0],
					type = "";
					 switch(event.type)
				{
					case "touchstart": type="mousedown"; break;
					case "touchmove":  type="mousemove"; break;        
					case "touchend":   type="mouseup"; break;
					default: return;
				}
			
				//initMouseEvent(type, canBubble, cancelable, view, clickCount, 
				//           screenX, screenY, clientX, clientY, ctrlKey, 
				//           altKey, shiftKey, metaKey, button, relatedTarget);
				
				var simulatedEvent = document.createEvent("MouseEvent");
				simulatedEvent.initMouseEvent(type, true, true, window, 1, 
										  first.screenX, first.screenY, 
										  first.clientX, first.clientY, false, 
										  false, false, false, 0/*left*/, null);
			
				first.target.dispatchEvent(simulatedEvent);
				event.preventDefault();
			}

			function init_renderer() {
				var renderer_created = true;
				if (option_RenderWebGL) {
					try {
						renderer = new THREE.WebGLRenderer();
						console.log("WebGL Renderer initialized");
						renderer_created = true;
 					} catch (err) {
 						console.log("WebGL Rendering failed");
 						option_RenderWebGL = false;
 					}
 				}
 				if (!option_RenderWebGL) {
 					try {
 						renderer = new THREE.CanvasRenderer();
 						console.log("Canvas Renderer initialized");
 						option_PanScreenWithMouse = false;
 //						option_TargetFPS = 1;
 					} catch (err) {
 						renderer_created = false;
 					}
 				}
 				if (renderer_created) {
					renderer.setSize( window.innerWidth, window.innerHeight );
					container.appendChild( renderer.domElement );
 				} else {
 					container.innerHTML = "<br/><br/><br/><h1>3D Rendering could not load</h1>";
 					console.log("FAIL! No renderer able to load");
 				}
			}
			function init_stats() {
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );
			}					

			function loadTexture( path ) {
			//TODO: Use the ImageUtils one correctly
				var texture = new THREE.Texture( texture_placeholder ),
					material = new THREE.MeshBasicMaterial( { map: texture } ),
					image = new Image();
				image.onload = function () {
					texture.needsUpdate = true;
					material.map.image = this;
//					render();
				};
				image.src = path;
				return material;
			}			
			function create_planet(planetid) {
				var mesh = new THREE.Mesh( new Sphere( Celestial.planetInfo(planetid,'pixelwidth'),option_SphereQuality,option_SphereQuality ),
					   new THREE.MeshBasicMaterial( { map: ImageUtils.loadTexture( Celestial.planetInfo(planetid,'texture')) } ) );
				mesh.overdraw = true;
				//TODO: Use PosRot
				mesh.position = Celestial.planetInfo(planetid,'position');
				mesh.rotation = Celestial.planetInfo(planetid,'rotation');
				mesh.name = Celestial.planetInfo(planetid,'name');
				mesh.planetid = planetid;
				return mesh;
			}
			function resizePlanets() {
				for ( var i = 0, l = planetmeshlist.length; i < l; i++ ) {
					renderer.removeObject( scene, planetmeshlist[i] );
					planetmeshlist[i] = create_planet(i);
					scene.addObject(planetmeshlist[i]);
				}
			}
			function clickit(mode) {
				switch(mode) {
				case 1:
				  Celestial.spacingMethod = 'evenly';
				  break;
				case 2:
				  Celestial.spacingMethod = 'realistic';
				  break;
				case 3:
				  Celestial.spacingMethod = 'artistic';
				  break;
				case 4:
				  Celestial.sizingMethod = 'equal';
				  resizePlanets();
				  break;
				case 5:
				  Celestial.sizingMethod = 'realistic';
				  resizePlanets();
				  break;
				case 6:
				  Celestial.sizingMethod = 'artistic';
				  resizePlanets();
				  break;
				case 7:
				  option_PanScreenWithMouse = !option_PanScreenWithMouse;
				  break;
				case 8:
				  loginfo = ((loginfo+1) % 3);
				  break;				  				  		
				case 9:
				  Celestial.spacingMethod = 'realistic';
				  Celestial.sizingMethod = 'realistic';
				  resizePlanets();				  
				  camera.position.x = -2;
				  camera.position.y = 40;
				  camera.position.z = 60;
				  mouseY = -13;
				  mouseX = -1;
				  break;
				case 10:
				  if (Celestial.time_display_method == 'yearday') {
				  	Celestial.time_display_method = 'date';
				  } else {
				    Celestial.time_display_method = 'yearday';
				  }
				  break;
				case 11:
				  option_TimeAdvanceType = 'd';
				  break;
				case 12:
				  option_TimeAdvanceType = 'h';
				  break;
				case 13:
				  option_TimeAdvanceType = 'm';
				  break;
				case 14:
				  option_TimeAdvanceType = 's';
				  break;
				}		

			}
			function planetWasClicked(planetid) {
				var P = Celestial.Planets[planetid];
				console.log("Planet "+P.planetName +" was clicked");
				
				var strP = "<div id='planetname'>"+P.planetName+"</div>";
				strP+= "<img src='"+Celestial.planetInfo(planetid,'texture')+"' height='130'>"

				planetinfo.innerHTML = strP;
				
			}
			function advanceAndPosition() {
				switch(option_TimeAdvanceType) {
				case 'd':
					Celestial.addDay();
					break;
				case 'h':
					Celestial.addHour();
					break;
				case 'm':
					Celestial.addMinute();
					break;
				case 's':
					Celestial.addSecond();
					break;
				}				
				
				for ( var i = 0, l = planetmeshlist.length; i < l; i++ ) {
					var posrot = Celestial.planetInfo(i,'posrot');
					planetmeshlist[i].position = posrot.position;//Celestial.planetInfo(i,'position');
					planetmeshlist[i].rotation = posrot.rotation;//Celestial.planetInfo(i,'rotation');
				}
				timedisplay.innerHTML = Celestial.displayTime();			
			}

			function onDocumentMouseMove( event ) {
				if (option_PanScreenWithMouse) {
					mouseX = ( event.clientX - windowHalfX );
					mouseY = ( event.clientY - windowHalfY );
				}
			}
			function onDocumentMouseDown( event ) {			
				event.preventDefault();

				//Look for what was clicked on
				var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
				projector.unprojectVector( vector, camera );
				var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
				var intersects = ray.intersectScene( scene );
				
//TODO: When planets are resized, they no longer are selectable in the scene
				var planetid;
				if ( intersects.length > 0 ) {
					//Test to make sure the last item isn't a skybox
					for ( var l = intersects.length, i = l-1; i >= 0; i-- ) {
						planetid = intersects[ i ].object.planetid;
						if (typeof(planetid) == "number") break; //We found a valid planet
					}
				}
				
				if (typeof(planetid) == "number") {  //Check if it's a number of a planet
					planetWasClicked(planetid);
				} else {
					//Planet not clicked, handle move instead
					if (option_ZoomOnClick) {
						event.stopPropagation();
						switch ( event.button ) {
							case 0: moveForward = true; break;
							case 2: moveBackward = true; break;		
						}
					}
				}
			}
			function onDocumentMouseUp( event ) {

				if (option_ZoomOnClick) {
					event.preventDefault();
					event.stopPropagation();
	
					switch ( event.button ) {
						case 0: moveForward = false; break;
						case 2: moveBackward = false; break;
					}
				}
			}
			function onDocumentMouseScroll( event ) {
				var delta = 0;
				if (!event) event = window.event;/* For IE. */
				if (event.wheelDelta) { /* IE/Opera. */
						delta = event.wheelDelta/120;
						if (window.opera) delta = -delta;
				} else if (event.detail) { /** Mozilla case. */
						delta = -event.detail/3;
				}
		
				if (delta) {
					if (delta > 0) {
						moveForward = true;
					} else {
						moveBackward = true;
					}
					moveShouldStop = true;
				}		
				if (event.preventDefault) event.preventDefault();
				event.returnValue = false;				
			}
			function onDocumentKeyDown( event ) {
				var code;
				if (event.keyCode) code = event.keyCode;
				
				if ((code == 80) || (code == 112)) clickit(7); //p or P
				if ((code == 76) || (code == 108)) clickit(8); //l or L
				if ((code == 43) || (code == 187)) {moveForward = true;moveShouldStop = true;}//+ or =
				if ((code == 45) || (code == 189)) {moveBackward = true;moveShouldStop = true;} //- or _
			}
			function onWindowResize( event ) {
			
				var width = window.innerWidth, height = window.innerHeight;
			
				camera.aspect = width / height;
				camera.updateProjectionMatrix();
			
				renderer.setSize( width, height );
				renderer.domElement.style.width = window.innerWidth + 'px';
				renderer.domElement.style.height = window.innerHeight + 'px';
			
			}

			function loop() {

				if ( moveForward )  {
					if (camera.position.z > 20) {
						camera.translateZ( - 10 );
						mouseY+=2;
					}
				}
				if ( moveBackward ) {
					if (camera.position.z < option_SolarSystem3DSizeXZ) {
						camera.translateZ( 10 ); mouseY-=2;
					}
				}
				if (moveShouldStop) { // stop moving if it was from scrolling
					moveForward = false; moveBackward = false;
				}

				camera.position.x += (   mouseX - camera.position.x ) * 0.05;
				camera.position.y += ( - mouseY - camera.position.y ) * 0.05;

				advanceAndPosition();
				
				renderer.render( scene, camera );
				stats.update();
			}


		</script>

	</body>
</html>
