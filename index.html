<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Celestial</title>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				color: #808080;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a, span {
				color: #0080ff;
				cursor: pointer; cursor: hand;
			}

		</style>
		<script type="text/javascript" src="js/Stats.js"></script>
		<script type="text/javascript" src="js/Three.js"></script>
		<script type="text/javascript" src="src/extras/ImageUtils.js"></script>
		<script type="text/javascript" src="src/extras/primitives/Plane.js"></script>
		<script type="text/javascript" src="src/extras/primitives/Sphere.js"></script>
		<script type="text/javascript" src="src/extras/primitives/Cylinder.js"></script>
		<script type="text/javascript" src="js/Celestial.js"></script>
		<script type="text/javascript" src="planets.json"></script>
	</head>
	<body>

		<div id="container"></div> 
		<div id="info">
	Spacing:<span id="click1" onclick="clickit(1)">Evenly</span>::<span id="click2" onclick="clickit(2)">Realistic</span>::<span id="click3" onclick="clickit(3)">Artistic</span>
	Sizing:<span id="click4" onclick="clickit(4)">Equal</span>::<span id="click5" onclick="clickit(5)">Realistic</span>::<span id="click6" onclick="clickit(6)">Artistic</span><br/>
	View:<span id="click7" onclick="clickit(7)">Panning(p)</span>::<span id="click8" onclick="clickit(8)">Log(l)</span>::<span id="click9" onclick="clickit(9)">Inner</span>
	<br/>	<span id="timedisplay" style="color:white"></span></div>


		<script type="text/javascript">
			var option_PanScreenWithMouse = false, //when mouse moves, use it to pan camera
				option_RenderWebGL = true, //Use the 3D graphics acceleration
				option_SphereQuality = 20, //how many tessalations to use when drawing spheres, more = higher resource use
				option_SolarSystem3DSizeXZ = 400, // how many "3d" pixels to use in the system length, width
				option_SolarSystem3DSizeY = 250; // how many "3d" pixels to use in the system's height
			
			var planetmeshlist = [];
			
			var container, stats, timedisplay;
			var camera, moveForward, moveBackward, moveShouldStop=false;
			var mesh, scene, renderer, projector;
			var loginfo=0;

			var mouseX = 0, mouseY = -100;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;


			init();
			setInterval( loop, 1000 / 60 );

			function init() {
				container = document.getElementById( 'container' );
				timedisplay=document.getElementById( 'timedisplay' );

				init_camera();

				scene = new THREE.Scene();

				init_grid();
				//init_shadow();
				init_planets();
				
				init_renderer();
				
				init_stats();
				clickit();

			}
			function init_grid() {
				// Top and bottom Cylinders (flat, so they look like circles)				
				// ( numSegs, topRad, botRad, height, topOffset, botOffset )
// 				var cylinder = new THREE.Mesh(new Cylinder( 20, option_SolarSystem3DSizeXZ, option_SolarSystem3DSizeXZ, 0, 0, 0),
// 					[new THREE.MeshBasicMaterial( {color: 0x222222, opacity: 1} ) ,
// 					 new THREE.MeshBasicMaterial( {color: 0x222222, wireframe: true }) ] );
// 				cylinder.position.x = 0;
// 				cylinder.position.y = ( option_SolarSystem3DSizeY);
// 				cylinder.position.z = 0;
// 				cylinder.rotation.x = (Math.PI / 2);
// 				scene.addObject(cylinder);

// 				var cylinder = new THREE.Mesh(new Cylinder( 20, option_SolarSystem3DSizeXZ, option_SolarSystem3DSizeXZ, 0, 0, 0),
// 					[new THREE.MeshBasicMaterial( {color: 0x222222, opacity: 1} ) ,
// 					 new THREE.MeshBasicMaterial( {color: 0x222222, wireframe: true }) ] );			 
// 				cylinder.position.x = 0;
// 				cylinder.position.y = (-1 * option_SolarSystem3DSizeY);
// 				cylinder.position.z = 0;
// 				cylinder.rotation.x = (Math.PI / 2);
// 				scene.addObject(cylinder);


				// Grid
				var geometry = new THREE.Geometry();
				geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( -1 * option_SolarSystem3DSizeXZ, 0, 0 ) ) );
				geometry.vertices.push( new THREE.Vertex( new THREE.Vector3( option_SolarSystem3DSizeXZ, 0, 0 ) ) );

				var material = new THREE.LineBasicMaterial( { color: 0x222222, opacity: 0.8 } );
				var lineSteps = 10;
				for ( var i = 0; i <= lineSteps; i ++ ) {
					var step = (option_SolarSystem3DSizeXZ *2) / lineSteps;

					var line = new THREE.Line( geometry, material );
					line.position.y = 0;
					line.position.z = ( i * step ) - option_SolarSystem3DSizeXZ;
					scene.addObject( line );

					var line = new THREE.Line( geometry, material );
					line.position.x = ( i * step ) - option_SolarSystem3DSizeXZ;
					line.position.y = 0;
					line.rotation.y = Math.PI / 2;
					scene.addObject( line );

				}
				console.log('Grid created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_shadow() {
				mesh = new THREE.Mesh( new Plane( 300, 300, 3, 3 ), new THREE.MeshBasicMaterial( { map: ImageUtils.loadTexture( 'textures/shadow.png' ) } ) );
				mesh.position.y = - 250;
				mesh.rotation.x = - 90 * Math.PI / 180;
				scene.addObject(mesh);
				console.log('Shadow created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_planets() {
				Celestial.init(planet_init_list,option_SolarSystem3DSizeXZ,option_SolarSystem3DSizeY);

				for ( var i = 0, l = Celestial.planetsCount(); i < l; i ++ ) {
					
					var mesh = create_planet(i);

					planetmeshlist.push( mesh );
					scene.addObject( mesh );
				}
			
				console.log('Planets created and added to Scene.  SceneObjects now:'+scene.objects.length);
			}
			function init_camera() {
				camera = new THREE.Camera( 60, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.y = 500;
				camera.position.z = 500;
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
				document.addEventListener( 'contextmenu', function ( event ) { event.preventDefault(); }, false ); //prevent right click menu
		        document.addEventListener( 'DOMMouseScroll', onDocumentMouseScroll, false);
		        document.addEventListener( 'mousewheel', onDocumentMouseScroll, false);
		        document.addEventListener( 'keydown', onDocumentKeyDown, false);

				projector = new THREE.Projector();

			}
			function init_renderer() {
				renderer = option_RenderWebGL ? new THREE.WebGLRenderer() : new THREE.CanvasRenderer();
				//renderer = new THREE.WebGLRenderer();
				//renderer = new THREE.CanvasRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );
			}
			function init_stats() {
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );
			}					
			function create_planet(planetid) {
				var mesh = new THREE.Mesh( new Sphere( Celestial.planetInfo(planetid,'pixelwidth'),option_SphereQuality,option_SphereQuality ),
					   new THREE.MeshBasicMaterial( { map: ImageUtils.loadTexture( Celestial.planetInfo(planetid,'texture')) } ) );
				mesh.overdraw = true;
				mesh.position = Celestial.planetInfo(planetid,'position');
				mesh.rotation = Celestial.planetInfo(planetid,'rotation');
				mesh.name = Celestial.planetInfo(planetid,'name');
				mesh.planetid = planetid;
				return mesh;
			}
			function resizePlanets() {
				for ( var i = 0, l = planetmeshlist.length; i < l; i++ ) {
					renderer.removeObject( scene, planetmeshlist[i] );
					planetmeshlist[i] = create_planet(i);
					scene.addObject(planetmeshlist[i]);
				}
			}
			function clickit(mode) {
				switch(mode) {
				case 1:
				  Celestial.spacingMethod = 'evenly';
				  break;
				case 2:
				  Celestial.spacingMethod = 'realistic';
				  break;
				case 3:
				  Celestial.spacingMethod = 'artistic';
				  break;
				case 4:
				  Celestial.sizingMethod = 'equal';
				  resizePlanets();
				  break;
				case 5:
				  Celestial.sizingMethod = 'realistic';
				  resizePlanets();
				  break;
				case 6:
				  Celestial.sizingMethod = 'artistic';
				  resizePlanets();
				  break;
				case 7:
				  option_PanScreenWithMouse = !option_PanScreenWithMouse;
				  break;
				case 8:
				  loginfo = ((loginfo+1) % 3);
				  break;				  				  		
				case 9:
				  Celestial.spacingMethod = 'realistic';
				  Celestial.sizingMethod = 'realistic';
				  resizePlanets();				  
				  camera.position.x = -2;
				  camera.position.y = 40;
				  camera.position.z = 60;
				  mouseY = -13;
				  mouseX = -1;
				  break;				  				  
				}		

			}
			

			
			function planetWasClicked(planetid) {
				var P = Celestial.Planets[planetid];
				console.log("Planet "+P.planetName +" was clicked");
			}


			function onDocumentMouseMove( event ) {
				if (option_PanScreenWithMouse) {
					mouseX = ( event.clientX - windowHalfX );
					mouseY = ( event.clientY - windowHalfY );
				}
			}
			function onDocumentMouseDown( event ) {			
				event.preventDefault();

				//Look for what was clicked on
				var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
				projector.unprojectVector( vector, camera );
				var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
				var intersects = ray.intersectScene( scene );

				var planetid;
				if ( intersects.length > 0 ) {
					planetid = intersects[ 0 ].object.planetid;
				}
				
				if (planetid) {
					planetWasClicked(planetid);
				} else {
					//Planet not clicked, handle move instead
					event.stopPropagation();
					switch ( event.button ) {
						case 0: moveForward = true; break;
						case 2: moveBackward = true; break;
	
					}
				}
			}
			function onDocumentMouseUp( event ) {
				event.preventDefault();
				event.stopPropagation();

				switch ( event.button ) {
					case 0: moveForward = false; break;
					case 2: moveBackward = false; break;
				}
			}
			function onDocumentMouseScroll( event ) {
				var delta = 0;
				if (!event) event = window.event;/* For IE. */
				if (event.wheelDelta) { /* IE/Opera. */
						delta = event.wheelDelta/120;
						if (window.opera) delta = -delta;
				} else if (event.detail) { /** Mozilla case. */
						delta = -event.detail/3;
				}
		
				if (delta) {
					if (delta > 0) {
						moveForward = true;
					} else {
						moveBackward = true;
					}
					moveShouldStop = true;
				}		
				if (event.preventDefault) event.preventDefault();
				event.returnValue = false;				
			}
			function onDocumentKeyDown( event ) {
				var code;
				if (event.keyCode) code = event.keyCode;
				
				if ((code == 80) || (code == 112)) clickit(7); //p or P
				if ((code == 76) || (code == 108)) clickit(8); //l or L
				if ((code == 43) || (code == 187)) {moveForward = true;moveShouldStop = true;}//+ or =
				if ((code == 45) || (code == 189)) {moveBackward = true;moveShouldStop = true;} //- or _
			}


			function advanceAndPosition() {
				Celestial.addMinute();
				for ( var i = 0, l = planetmeshlist.length; i < l; i++ ) {
					var posrot = Celestial.planetInfo(i,'posrot');
					planetmeshlist[i].position = posrot.position;//Celestial.planetInfo(i,'position');
					planetmeshlist[i].rotation = posrot.rotation;//Celestial.planetInfo(i,'rotation');
				}
				timedisplay.innerHTML = Celestial.displayTime();			
			}

			function loop() {

				if ( moveForward )  { camera.translateZ( - 10 ); mouseY+=2;}
				if ( moveBackward ) { camera.translateZ( 10 ); mouseY-=2;}
				if (moveShouldStop) { // stop moving if it was from scrolling
					moveForward = false; moveBackward = false;
				}

				camera.position.x += ( mouseX - camera.position.x ) * 0.05;
				camera.position.y += ( - mouseY - camera.position.y ) * 0.05;

				advanceAndPosition();
				
				renderer.render( scene, camera );
				stats.update();
			}


		</script>

	</body>
</html>
